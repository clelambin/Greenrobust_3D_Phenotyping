Greenrobust - A workflow for the 3D phenotyping of greenhouse plants
====================================================================

## Overview

Set of scripts used for the automation of 3D phenotyping of greenhouse plants for the [Excelence Cluster Greerobust][greenrobust.de].

The 3D phenotyping process is split into 4 steps. The scripts related to each steps is stored into a separate subfolder as such:
1. Picture taking
2. Picture pre-processing &rarr; aa_image_preparation/
3. 3D Model generation &rarr; bb_metashape_plant_digitisation/
4. 3D Model processing &rarr; cc_blender_plant_volume/ and dd_data_analysis_r/

## Script details

Each subfolder are independant and help the process of its respective step *(see [Overview](#overview)*).

### aa_image_preparation

**Overview:**
Create mask of images based on Otsu and Adaptive threshold. Running this script is optional and only recommanded if no background images *(image without the plant, matching the camera position)* have been taken.

**Usage:**
Open batchthreshold_with_exif_extract.ipynb with Jupyter lab, edit the working directory and run the Batch thresholding cell.

### bb_metashape_plant_digitisation

**Overview:**
For each subfolder in the working directory, import images and generate 3D model based on input images.

**Prerequisite:**
The folder structure containing the images to load in metashape can have one of two structures, depending on the masking stategy:

- Masks generated by the script in aa_image_preparation: nothing to change, the scripts in aa_image_preparation prepare the folder structure needed for the metashape script

- Mask generated in Metashape based on background image *(recommended method)*: One background image should be given for each camera position and named : "<camera_folder>_background.JPG". The background image can be in the plant subfolder or in the whole project folder. If one background is present both, the one in the plant subfolder has the precedence. Here is an example of folder structure:

```
    - Species1/
        - Camera_high/
        - Camera_mid/
        - Camera_low/
        - Camera_high_background.JPG
        - Camera_mid_backgournd.JPG
        - Camera_low_background.JPG
    - Species2/
        - Camera_high/
        - Camera_mid/
        - Camera_low/
        - Camera_high_background.JPG
        - Camera_mid_backgournd.JPG
        - Camera_low_background.JPG
```

**Usage:**
Call the script metashape_batchprocess.py from Metashape after defining the working directory. By default, the working directory is the active directory, which can be changed in Metashape console by running the following:

```python
import os
os.chdir(r"<path_to_input_folder>")
```

The script will process any subfolder within the working directory which start with the species initial *(currently: BR, HS, HV, NB, SD, SL, TA)*.

The saved Metashape and 3D model files are saved in a subfolder of the working directory defined by the variable output_dir.

### cc_blender_plant_volume

**Overview:**
Cleanup 3D model generated by Metashape and reposition/rescale model to be alligned with origin and its pot matching the defined dimension. Generate a table which contains extracted values from the 3D model (volume, plant height, ...).
Uses color filter to detect the pot and cup and uses them to allign the model. This step is mostly useful in case no markers were detected from Metashape.

**Prerequisite:**
Some functions uses the modules not installed in the python version within blender. To install them in Linux, run the following command:

```bash
<path_to_blender>/<version>/python/bin/python -m pip install pillow --user
<path_to_blender>/<version>/python/bin/python -m pip install open3d --user
<path_to_blender>/<version>/python/bin/python -m pip install pybind11-rdp --user 
```

Once installed, replace the path in the variable `LOCAL_LIBRARY` in `add_module.py` to the path where the module got installed. In my case: `/home/clement/.local/lib/python3.10/site-packages`

In Windows, the same process can be done using the powershell (path in Windows are \ instead of /).

To find the path to the python executable package with python, you can run the following code with teh python console in Blender:

```python
import sys
print(sys.executable)
```

Note that the latest version of Blender might come packaged with python 3.13, which is not yet compatible with Open3D, in that case, use an older version of Blender.

**Usage:**
Update paths to module and python local library in add_module.py. Update the working and output path in `__init__.py`.
In blender, call `add_module.py` then `__init__.py` to start the process.

To generate a 3D rendering of the 3D model, run the script blender_plant_rendering.py in a blender file which contains the models to render and the seting for the turntable animation.

### dd_data_analysis_r

**Overview:**
Fit harvest data (biomass, ...) to values extracted from the 3D model. Fit different linear model and evaluate model accuracy.

**Usage:**
Upload csv table with harvest and 3D model data and run the R script.

## Software/library version

This package have been written and tested using the following software/library version:

- aa_image_preparation
  - python 3.12
- bb_metashape_plant_digitisation
  - Agrisoft Metashape Professional 2.2.0
  - python 3.9 (packaged in Metashape)
- cc_blender_plant_volume
  - Blender 3.6 to 4.4
  - python 3.11 (packaged in Blender)
- dd_data_analysis_r
  - R 4.5.0
